<div class="admin-container">
  <div class="admin-header">
    <div class="header-content">
      <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
      <div class="header-actions">
  <!-- Reuse logout-btn styling so header buttons are consistent and not underlined -->
  <button routerLink="/profile" class="logout-btn header-btn btn-animate"><i class="fas fa-user"></i> Profile</button>
  <button routerLink="/chat" class="logout-btn header-btn"><i class="fas fa-robot"></i> AI Chat</button>
  <!-- Admin quick links: only visible to admin users -->
  <button routerLink="/department-budget" *ngIf="authService.getUserRole() === 'admin'" class="logout-btn header-btn"><i class="fas fa-landmark"></i> Dept Budget</button>
  <button routerLink="/staff-payroll" *ngIf="authService.getUserRole() === 'admin'" class="logout-btn header-btn"><i class="fas fa-users-cog"></i> Staff Payroll</button>
        <button class="logout-btn header-btn" (click)="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="admin-tabs">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'dashboard'"
      (click)="setActiveTab('dashboard')">
      <i class="fas fa-chart-line"></i> Dashboard
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'users'"
      (click)="setActiveTab('users')">
      <i class="fas fa-users"></i> User Management
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'fees'"
      (click)="setActiveTab('fees')">
      <i class="fas fa-dollar-sign"></i> Tuition & Fees
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'policies'"
      (click)="setActiveTab('policies')">
      <i class="fas fa-cog"></i> Payment Policies
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'refunds'"
      (click)="setActiveTab('refunds')">
      <i class="fas fa-undo"></i> Refunds
    </button>
  </div>

  <div class="admin-content">
    <!-- Dashboard Tab -->
    <div *ngIf="activeTab === 'dashboard'" class="tab-content">
      <h2><i class="fas fa-chart-pie"></i> Reporting Dashboard</h2>

      <div class="stats-grid">
        <div class="stat-card revenue">
          <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
          <div class="stat-info">
            <h3>Total Revenue</h3>
            <p class="stat-value">{{ formatCurrency(totalRevenue) }}</p>
          </div>
        </div>

        <div class="stat-card unpaid">
          <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <div class="stat-info">
            <h3>Unpaid Students</h3>
            <p class="stat-value">{{ unpaidStudents.length }}</p>
          </div>
        </div>

        <div class="stat-card users">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-info">
            <h3>Total Users</h3>
            <p class="stat-value">{{ users.length }}</p>
          </div>
        </div>

        <div class="stat-card payments">
          <div class="stat-icon"><i class="fas fa-credit-card"></i></div>
          <div class="stat-info">
            <h3>Total Payments</h3>
            <p class="stat-value">{{ paymentHistory.length }}</p>
          </div>
        </div>
      </div>

      <div class="dashboard-sections">
        <div class="dashboard-section">
          <h3><i class="fas fa-user-times"></i> Unpaid Students</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Total Due</th>
                  <th>Paid</th>
                  <th>Unpaid</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let student of unpaidStudents">
                  <td>{{ student.name }}</td>
                  <td>{{ student.username }}</td>
                  <td>{{ student.email }}</td>
                  <td>{{ formatCurrency(student.totalDue) }}</td>
                  <td>{{ formatCurrency(student.totalPaid) }}</td>
                  <td class="unpaid-amount">{{ formatCurrency(student.unpaid) }}</td>
                </tr>
                <tr *ngIf="unpaidStudents.length === 0">
                  <td colspan="6" class="no-data">No unpaid students</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="dashboard-section">
          <h3><i class="fas fa-history"></i> Recent Payment History</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Method</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of paymentHistory.slice(0, 10)">
                  <td>{{ payment.username }}</td>
                  <td>{{ formatCurrency(payment.amount) }}</td>
                  <td>{{ formatDate(payment.paymentDate) }}</td>
                  <td><span class="status-badge" [class.completed]="payment.status === 'completed'">{{ payment.status }}</span></td>
                  <td>{{ payment.paymentMethod }}</td>
                </tr>
                <tr *ngIf="paymentHistory.length === 0">
                  <td colspan="5" class="no-data">No payment history</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div *ngIf="activeTab === 'users'" class="tab-content">
      <h2><i class="fas fa-users-cog"></i> User Management</h2>

      <div class="form-section">
        <h3>Create New User</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Username *</label>
            <input type="text" [(ngModel)]="newUser.username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label>Password *</label>
            <input type="password" [(ngModel)]="newUser.password" placeholder="Enter password">
          </div>
          <div class="form-group">
            <label>First Name</label>
            <input type="text" [(ngModel)]="newUser.firstname" placeholder="Enter first name">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" [(ngModel)]="newUser.lastname" placeholder="Enter last name">
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="newUser.email" placeholder="Enter email">
          </div>
          <div class="form-group">
            <label>Role *</label>
            <select [(ngModel)]="newUser.role">
              <option value="student">Student</option>
              <option value="accounting">Accounting Personnel</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" (click)="createUser()">
          <i class="fas fa-plus"></i> Create User
        </button>
      </div>

      <div class="table-section">
        <h3>All Users</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Wallet Balance</th>
                <th>Outstanding Fees</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of users">
                <td *ngIf="editingUser?.id !== user.id">{{ user.username }}</td>
                <td *ngIf="editingUser?.id === user.id && editingUser">
                  <input type="text" [(ngModel)]="editingUser.username" class="inline-input">
                </td>
                <td *ngIf="editingUser?.id !== user.id">{{ user.firstname }} {{ user.lastname }}</td>
                <td *ngIf="editingUser?.id === user.id && editingUser">
                  <input type="text" [(ngModel)]="editingUser.firstname" placeholder="First" class="inline-input">
                  <input type="text" [(ngModel)]="editingUser.lastname" placeholder="Last" class="inline-input">
                </td>
                <td *ngIf="editingUser?.id !== user.id">{{ user.email }}</td>
                <td *ngIf="editingUser?.id === user.id && editingUser">
                  <input type="email" [(ngModel)]="editingUser.email" class="inline-input">
                </td>
                <td *ngIf="editingUser?.id !== user.id">
                  <span class="role-badge" [class]="user.role">{{ user.role }}</span>
                </td>
                <td *ngIf="editingUser?.id === user.id && editingUser">
                  <select [(ngModel)]="editingUser.role" class="inline-select">
                    <option value="student">Student</option>
                    <option value="accounting">Accounting Personnel</option>
                    <option value="admin">Admin</option>
                  </select>
                </td>
                <td *ngIf="editingUser?.id !== user.id">
                  <span class="status-badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                    {{ user.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
                <td *ngIf="editingUser?.id === user.id && editingUser">
                  <input type="checkbox" [(ngModel)]="editingUser.isActive" class="inline-checkbox">
                </td>
                <td *ngIf="editingUser?.id !== user.id">
                  <span *ngIf="user.role === 'student'" class="balance-amount">
                    {{ formatCurrency(getStudentWalletBalance(user)) }}
                  </span>
                  <span *ngIf="user.role !== 'student'">-</span>
                </td>
                <td *ngIf="editingUser?.id === user.id && editingUser">-</td>
                <td *ngIf="editingUser?.id !== user.id">
                  <span *ngIf="user.role === 'student'" class="unpaid-amount">
                    {{ formatCurrency(getStudentOutstandingFees(user)) }}
                  </span>
                  <span *ngIf="user.role !== 'student'">-</span>
                </td>
                <td *ngIf="editingUser?.id === user.id && editingUser">-</td>
                <td *ngIf="editingUser?.id !== user.id">
                  <button class="btn btn-sm btn-edit" (click)="editUser(user)">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-toggle" (click)="toggleUserStatus(user)">
                    <i class="fas" [class.fa-toggle-on]="user.isActive" [class.fa-toggle-off]="!user.isActive"></i>
                  </button>
                  <button *ngIf="user.role === 'student'" class="btn btn-sm btn-success" (click)="openWalletModal(user)" title="Top Up Wallet">
                    <i class="fas fa-wallet"></i> Top Up
                  </button>
                  <button *ngIf="user.role === 'student'" class="btn btn-sm btn-primary" (click)="openFeeModal(user)" title="Add Fee">
                    <i class="fas fa-dollar-sign"></i> Add Fee
                  </button>
                  <button class="btn btn-sm btn-delete" (click)="deleteUser(user.id)">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
                <td *ngIf="editingUser?.id === user.id" colspan="5">
                  <button class="btn btn-sm btn-save" (click)="updateUser()">
                    <i class="fas fa-check"></i> Save
                  </button>
                  <button class="btn btn-sm btn-cancel" (click)="cancelEditUser()">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tuition & Fees Tab -->
    <div *ngIf="activeTab === 'fees'" class="tab-content">
      <h2><i class="fas fa-dollar-sign"></i> Tuition & Fee Management</h2>

      <!-- Fee Categories -->
      <div class="form-section">
        <h3>Fee Categories</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Category Name *</label>
            <input type="text" [(ngModel)]="newCategory.name" placeholder="e.g., Tuition Fee">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" [(ngModel)]="newCategory.description" placeholder="Category description">
          </div>
          <div class="form-group">
            <label>Default Amount *</label>
            <input type="number" [(ngModel)]="newCategory.amount" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>
        <button class="btn btn-primary" (click)="createFeeCategory()">
          <i class="fas fa-plus"></i> Add Category
        </button>
      </div>

      <div class="table-section">
        <h3>All Fee Categories</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Default Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let category of feeCategories">
                <td *ngIf="editingCategory?.id !== category.id">{{ category.name }}</td>
                <td *ngIf="editingCategory?.id === category.id && editingCategory">
                  <input type="text" [(ngModel)]="editingCategory.name" class="inline-input">
                </td>
                <td *ngIf="editingCategory?.id !== category.id">{{ category.description }}</td>
                <td *ngIf="editingCategory?.id === category.id && editingCategory">
                  <input type="text" [(ngModel)]="editingCategory.description" class="inline-input">
                </td>
                <td *ngIf="editingCategory?.id !== category.id">{{ formatCurrency(category.amount) }}</td>
                <td *ngIf="editingCategory?.id === category.id && editingCategory">
                  <input type="number" [(ngModel)]="editingCategory.amount" class="inline-input" step="0.01">
                </td>
                <td *ngIf="editingCategory?.id !== category.id">
                  <span class="status-badge" [class.active]="category.isActive">{{ category.isActive ? 'Active' : 'Inactive' }}</span>
                </td>
                <td *ngIf="editingCategory?.id === category.id && editingCategory">
                  <input type="checkbox" [(ngModel)]="editingCategory.isActive" class="inline-checkbox">
                </td>
                <td *ngIf="editingCategory?.id !== category.id">
                  <button class="btn btn-sm btn-edit" (click)="editFeeCategory(category)">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-delete" (click)="deleteFeeCategory(category.id)">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
                <td *ngIf="editingCategory?.id === category.id" colspan="2">
                  <button class="btn btn-sm btn-save" (click)="updateFeeCategory()">
                    <i class="fas fa-check"></i> Save
                  </button>
                  <button class="btn btn-sm btn-cancel" (click)="cancelEditCategory()">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Fee Structures -->
      <div class="form-section">
        <h3>Fee Structures (Yearly Fees)</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Fee Category *</label>
            <select [(ngModel)]="newStructure.categoryId">
              <option value="">Select Category</option>
              <option *ngFor="let cat of feeCategories" [value]="cat.id">{{ cat.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Academic Year *</label>
            <input type="text" [(ngModel)]="newStructure.academicYear" placeholder="e.g., 2024-2025">
          </div>
          <div class="form-group">
            <label>Amount *</label>
            <input type="number" [(ngModel)]="newStructure.amount" placeholder="0.00" step="0.01" min="0">
          </div>
          <div class="form-group">
            <label>Due Date *</label>
            <input type="date" [(ngModel)]="newStructure.dueDate">
          </div>
        </div>
        <button class="btn btn-primary" (click)="createFeeStructure()">
          <i class="fas fa-plus"></i> Add Fee Structure
        </button>
      </div>

      <div class="table-section">
        <h3>All Fee Structures</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Academic Year</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let structure of feeStructures">
                <td *ngIf="editingStructure?.id !== structure.id">{{ structure.categoryName }}</td>
                <td *ngIf="editingStructure?.id === structure.id && editingStructure">
                  <select [(ngModel)]="editingStructure.categoryId" class="inline-select">
                    <option *ngFor="let cat of feeCategories" [value]="cat.id">{{ cat.name }}</option>
                  </select>
                </td>
                <td *ngIf="editingStructure?.id !== structure.id">{{ structure.academicYear }}</td>
                <td *ngIf="editingStructure?.id === structure.id && editingStructure">
                  <input type="text" [(ngModel)]="editingStructure.academicYear" class="inline-input">
                </td>
                <td *ngIf="editingStructure?.id !== structure.id">{{ formatCurrency(structure.amount) }}</td>
                <td *ngIf="editingStructure?.id === structure.id && editingStructure">
                  <input type="number" [(ngModel)]="editingStructure.amount" class="inline-input" step="0.01">
                </td>
                <td *ngIf="editingStructure?.id !== structure.id">{{ formatDate(structure.dueDate) }}</td>
                <td *ngIf="editingStructure?.id === structure.id && editingStructure">
                  <input type="date" [(ngModel)]="editingStructure.dueDate" class="inline-input">
                </td>
                <td *ngIf="editingStructure?.id !== structure.id">
                  <span class="status-badge" [class.active]="structure.isActive">{{ structure.isActive ? 'Active' : 'Inactive' }}</span>
                </td>
                <td *ngIf="editingStructure?.id === structure.id && editingStructure">
                  <input type="checkbox" [(ngModel)]="editingStructure.isActive" class="inline-checkbox">
                </td>
                <td *ngIf="editingStructure?.id !== structure.id">
                  <button class="btn btn-sm btn-edit" (click)="editFeeStructure(structure)">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-delete" (click)="deleteFeeStructure(structure.id)">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
                <td *ngIf="editingStructure?.id === structure.id" colspan="2">
                  <button class="btn btn-sm btn-save" (click)="updateFeeStructure()">
                    <i class="fas fa-check"></i> Save
                  </button>
                  <button class="btn btn-sm btn-cancel" (click)="cancelEditStructure()">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payment Policies Tab -->
    <div *ngIf="activeTab === 'policies'" class="tab-content">
      <h2><i class="fas fa-cog"></i> Payment & Policy Control</h2>

      <div class="form-section">
        <h3>Create Payment Policy</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Policy Type *</label>
            <select [(ngModel)]="newPolicy.policyType">
              <option value="deadline">Deadline</option>
              <option value="penalty">Penalty</option>
              <option value="installment">Installment Rule</option>
              <option value="refund">Refund Policy</option>
            </select>
          </div>
          <div class="form-group">
            <label>Policy Name *</label>
            <input type="text" [(ngModel)]="newPolicy.name" placeholder="e.g., Fall Semester Deadline">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" [(ngModel)]="newPolicy.description" placeholder="Policy description">
          </div>
          <div class="form-group">
            <label>Value *</label>
            <input type="number" [(ngModel)]="newPolicy.value" placeholder="0" step="0.01" min="0">
            <small>Days for deadline, percentage for penalty, count for installments</small>
          </div>
        </div>
        <button class="btn btn-primary" (click)="createPaymentPolicy()">
          <i class="fas fa-plus"></i> Create Policy
        </button>
      </div>

      <div class="table-section">
        <h3>All Payment Policies</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Description</th>
                <th>Value</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let policy of paymentPolicies">
                <td *ngIf="editingPolicy?.id !== policy.id">
                  <span class="policy-type-badge" [class]="policy.policyType">{{ policy.policyType }}</span>
                </td>
                <td *ngIf="editingPolicy?.id === policy.id && editingPolicy">
                  <select [(ngModel)]="editingPolicy.policyType" class="inline-select">
                    <option value="deadline">Deadline</option>
                    <option value="penalty">Penalty</option>
                    <option value="installment">Installment Rule</option>
                    <option value="refund">Refund Policy</option>
                  </select>
                </td>
                <td *ngIf="editingPolicy?.id !== policy.id">{{ policy.name }}</td>
                <td *ngIf="editingPolicy?.id === policy.id && editingPolicy">
                  <input type="text" [(ngModel)]="editingPolicy.name" class="inline-input">
                </td>
                <td *ngIf="editingPolicy?.id !== policy.id">{{ policy.description }}</td>
                <td *ngIf="editingPolicy?.id === policy.id && editingPolicy">
                  <input type="text" [(ngModel)]="editingPolicy.description" class="inline-input">
                </td>
                <td *ngIf="editingPolicy?.id !== policy.id">{{ policy.value }}</td>
                <td *ngIf="editingPolicy?.id === policy.id && editingPolicy">
                  <input type="number" [(ngModel)]="editingPolicy.value" class="inline-input" step="0.01">
                </td>
                <td *ngIf="editingPolicy?.id !== policy.id">
                  <span class="status-badge" [class.active]="policy.isActive">{{ policy.isActive ? 'Active' : 'Inactive' }}</span>
                </td>
                <td *ngIf="editingPolicy?.id === policy.id && editingPolicy">
                  <input type="checkbox" [(ngModel)]="editingPolicy.isActive" class="inline-checkbox">
                </td>
                <td *ngIf="editingPolicy?.id !== policy.id">
                  <button class="btn btn-sm btn-edit" (click)="editPaymentPolicy(policy)">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-delete" (click)="deletePaymentPolicy(policy.id)">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
                <td *ngIf="editingPolicy?.id === policy.id" colspan="2">
                  <button class="btn btn-sm btn-save" (click)="updatePaymentPolicy()">
                    <i class="fas fa-check"></i> Save
                  </button>
                  <button class="btn btn-sm btn-cancel" (click)="cancelEditPolicy()">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Refunds Tab -->
    <div *ngIf="activeTab === 'refunds'" class="tab-content">
      <h2><i class="fas fa-undo"></i> Refund Management</h2>

      <div class="table-section">
        <h3>Refund Requests</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Amount</th>
                <th>Reason</th>
                <th>Requested Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of refundRequests">
                <td>{{ request.username }}</td>
                <td>{{ formatCurrency(request.amount) }}</td>
                <td>{{ request.reason }}</td>
                <td>{{ formatDate(request.requestedDate) }}</td>
                <td>
                  <span class="status-badge"
                        [class.pending]="request.status === 'pending'"
                        [class.approved]="request.status === 'approved'"
                        [class.rejected]="request.status === 'rejected'">
                    {{ request.status }}
                  </span>
                </td>
                <td>
                  <button
                    *ngIf="request.status === 'pending'"
                    class="btn btn-sm btn-approve"
                    (click)="approveRefund(request.id)">
                    <i class="fas fa-check"></i> Approve
                  </button>
                  <button
                    *ngIf="request.status === 'pending'"
                    class="btn btn-sm btn-reject"
                    (click)="rejectRefund(request.id)">
                    <i class="fas fa-times"></i> Reject
                  </button>
                  <span *ngIf="request.status !== 'pending'">-</span>
                </td>
              </tr>
              <tr *ngIf="refundRequests.length === 0">
                <td colspan="6" class="no-data">No refund requests</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Student Fee Modal -->
<div class="modal-overlay" *ngIf="showFeeModal" (click)="closeFeeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-dollar-sign"></i> Add Outstanding Balance</h3>
      <button class="modal-close" (click)="closeFeeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedStudentForFee">
      <div class="form-group">
        <label>Student:</label>
        <p class="form-value">{{ selectedStudentForFee.firstname }} {{ selectedStudentForFee.lastname }} ({{ selectedStudentForFee.username }})</p>
      </div>
      <div class="form-group">
        <label>Current Outstanding Fees:</label>
        <p class="form-value unpaid-amount">{{ formatCurrency(getStudentOutstandingFees(selectedStudentForFee)) }}</p>
      </div>
      <div class="form-group">
        <label>Fee Structure *</label>
        <select [(ngModel)]="newStudentFee.feeStructureId" class="form-input" (change)="newStudentFee.amount = 0">
          <option value="">Select Fee Structure (or enter custom amount below)</option>
          <option *ngFor="let fs of feeStructures" [value]="fs.id">
            {{ fs.categoryName }} - {{ fs.academicYear }} ({{ formatCurrency(fs.amount) }})
          </option>
        </select>
        <small>Select a fee structure to use its amount, or leave empty and enter a custom amount</small>
      </div>
      <div class="form-group">
        <label>Custom Amount (if no fee structure selected) *</label>
        <input
          type="number"
          [(ngModel)]="newStudentFee.amount"
          step="0.01"
          min="0"
          class="form-input"
          [disabled]="!!newStudentFee.feeStructureId"
          placeholder="Enter amount">
        <small *ngIf="newStudentFee.feeStructureId">Amount will be taken from selected fee structure</small>
      </div>
      <div class="form-group">
        <label>Description (Optional)</label>
        <input
          type="text"
          [(ngModel)]="newStudentFee.description"
          class="form-input"
          placeholder="Optional description for this fee">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeFeeModal()">Cancel</button>
      <button
        class="btn btn-primary"
        (click)="addStudentFee()"
        [disabled]="!newStudentFee.feeStructureId && newStudentFee.amount <= 0">
        <i class="fas fa-plus"></i> Add Fee
      </button>
    </div>
  </div>
</div>

<!-- Top Up Wallet Modal -->
<div class="modal-overlay" *ngIf="showWalletModal" (click)="closeWalletModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-wallet"></i> Top Up Wallet Balance</h3>
      <button class="modal-close" (click)="closeWalletModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedStudentForWallet">
      <div class="form-group">
        <label>Student:</label>
        <p class="form-value">{{ selectedStudentForWallet.firstname }} {{ selectedStudentForWallet.lastname }} ({{ selectedStudentForWallet.username }})</p>
      </div>
      <div class="form-group">
        <label>Current Wallet Balance:</label>
        <p class="form-value balance-amount">{{ formatCurrency(getStudentWalletBalance(selectedStudentForWallet)) }}</p>
      </div>
      <div class="form-group">
        <label>Amount to Add *</label>
        <input
          type="number"
          [(ngModel)]="walletTopUpAmount"
          step="0.01"
          min="0.01"
          class="form-input"
          placeholder="Enter amount to add">
        <small>Enter the amount you want to add to the student's wallet balance</small>
      </div>
      <div class="form-group" *ngIf="walletTopUpAmount > 0">
        <label>New Wallet Balance:</label>
        <p class="form-value balance-amount">{{ formatCurrency(getStudentWalletBalance(selectedStudentForWallet) + walletTopUpAmount) }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeWalletModal()">Cancel</button>
      <button
        class="btn btn-success"
        (click)="topUpWallet()"
        [disabled]="walletTopUpAmount <= 0">
        <i class="fas fa-plus"></i> Top Up Wallet
      </button>
    </div>
  </div>
</div>
